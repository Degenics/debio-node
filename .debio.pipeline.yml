---
kind: pipeline
type: docker
name: debio substrate deployment
trigger:
  branch:
    - development
    - master
    - staging
  event:
    - pull_request

platform:
  os: linux
  arch: amd64

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock
  - name: whitelist
    host:
      path: /etc/docker/daemon.json
  - name: toolkit
    host:
      path: /data/drone_data

steps:
  - name: verify pull request
    pull: if-not-exists
    image: alpine/git
    volumes:
      - name: toolkit
        path: /data/drone_data
    commands:
      - /data/drone_data/debio_toolkit -approval -repo=debionetwork/debio-node -id=${DRONE_PULL_REQUEST}
    when:
      branch:
        - master
        - staging
        - development

  - name: build - devel
    pull: if-not-exists
    image: google/cloud-sdk:alpine
    volumes:
      - name: toolkit
        path: /data/drone_data
    commands:
      - echo '/data/drone_data/debio_toolkit -vault  -secret=debio_development/data/debio_substrate'
      - /data/drone_data/gcmd/build_substrate_dev
    when:
      branch:
        - development

  - name: build - staging
    pull: if-not-exists
    image: google/cloud-sdk:alpine
    volumes:
      - name: toolkit
        path: /data/drone_data
    commands:
      - echo '/data/drone_data/debio_toolkit -vault  -secret=debio_staging/data/debio_substrate'
      - /data/drone_data/gcmd/build_substrate_stg
    when:
      branch:
        - staging

  - name: build - demo
    pull: if-not-exists
    image: google/cloud-sdk:alpine
    volumes:
      - name: toolkit
        path: /data/drone_data
    commands:
      - echo '/data/drone_data/debio_toolkit -vault  -secret=debio_production/data/debio_substrate'
      - /data/drone_data/gcmd/build_substrate_prod
    when:
      branch:
        - master

  - name: merge pull request
    pull: if-not-exists
    image: alpine/git
    volumes:
      - name: toolkit
        path: /data/drone_data
    commands:
      - /data/drone_data/debio_toolkit -merge -repo=debionetwork/debio-node -id=${DRONE_PULL_REQUEST}
    when:
      branch:
        - master
        - staging
        - development

  - name: reload service - devel
    pull: if-not-exists
    image: appleboy/drone-ssh
    volumes:
      - name: toolkit
        path: /data/drone_data
    settings:
      host:
        from_secret: devel_host
      username:
        from_secret: devel_uname
      key_path: /data/drone_data/.ssh/id_rsa
      port: 22
      script:
        - docker stop debio_substrate_service || true && docker rm debio_substrate_service || true
        - docker rmi hub.debio.network/debio_substrate_dev:latest && docker pull hub.debio.network/debio_substrate_dev:latest
        - docker run -d --network=host --name=debio_substrate_service -v /etc/localtime:/etc/localtime:ro --restart=always hub.debio.network/debio_substrate_dev:latest --unsafe-ws-external
    when:
      branch:
        - development

  - name: reload service - staging
    pull: if-not-exists
    image: appleboy/drone-ssh
    volumes:
      - name: toolkit
        path: /data/drone_data
    settings:
      host:
        from_secret: stg_host
      username:
        from_secret: stg_uname
      key_path: /data/drone_data/.ssh/id_rsa
      port: 22
      script:
        - docker stop debio_substrate_service || true && docker rm debio_substrate_service || true
        - docker rmi hub.debio.network/debio_substrate_staging:latest && docker pull hub.debio.network/debio_substrate_staging:latest
        - docker run -d --name=debio_substrate_service -v /etc/localtime:/etc/localtime:ro -p 0.0.0.0:9944:9944 --restart=always hub.debio.network/debio_substrate_staging:latest --unsafe-ws-external
    when:
      branch:
        - staging

  - name: reload service - demo
    pull: if-not-exists
    image: appleboy/drone-ssh
    volumes:
      - name: toolkit
        path: /data/drone_data
    settings:
      host:
        from_secret: sub_host
      username:
        from_secret: sub_uname
      key_path: /data/drone_data/.ssh/id_rsa
      port: 22
      script:
        - docker stop debio_substrate_service || true && docker rm debio_substrate_service || true
        - docker rmi hub.debio.network/debio_substrate_service:latest && docker pull hub.debio.network/debio_substrate_service:latest
        - docker run -d --name=debio_substrate_service -v /etc/localtime:/etc/localtime:ro -p 0.0.0.0:9944:9944 --restart=always hub.debio.network/debio_substrate_service:latest --unsafe-ws-external
    when:
      branch:
        - master

  - name: notify deployment
    image: appleboy/drone-discord
    pull: if-not-exists
    settings:
      webhook_id:
        from_secret: discord_id
      webhook_token:
        from_secret: discord_token
      message: >
        {{#success build.status}}
        ✅ Build #{{build.number}} of `{{repo.name}}` succeeded.

        📝 Commit by {{commit.author}} on

        `{{commit.branch}}`:

        ```
        {{commit.message}}
        ```

        🌐 {{ build.link }}
        {{else}}
        ❌ Build #{{build.number}} of `{{repo.name}}` failed.

        📝 Commit by {{commit.author}} on

        `{{commit.branch}}`:

        ```
        {{commit.message}}
        ```
        🌐 {{ build.link }}
        🌐 {{ commit.link }}
        {{/success}}
    when:
      status: [ success, failure ]
      branch:
        - master
        - staging
        - development

---
kind: secret
name: devel_host
get:
  path: drone_development/deploy_target
  name: devel_host
---
kind: secret
name: devel_key
get:
  path: drone_development/deploy_target
  name: devel_key
---
kind: secret
name: devel_uname
get:
  path: drone_development/deploy_target
  name: devel_uname
---
kind: secret
name: stg_host
get:
  path: drone_staging/deploy_target
  name: stg_host
---
kind: secret
name: stg_key
get:
  path: drone_staging/deploy_target
  name: stg_key
---
kind: secret
name: stg_uname
get:
  path: drone_staging/deploy_target
  name: stg_uname
---
kind: secret
name: sub_host
get:
  path: drone_production/substrate_target
  name: sub_host
---
kind: secret
name: sub_key
get:
  path: drone_production/substrate_target
  name: sub_key
---
kind: secret
name: sub_uname
get:
  path: drone_production/substrate_target
  name: sub_uname
---
kind: secret
name: discord_id
get:
  path: drone_common_config/webhook
  name: discord_id
---
kind: secret
name: discord_token
get:
  path: drone_common_config/webhook
  name: discord_token
---
kind: secret
name: deploy_auth
get:
  path: drone_common_config/file_path
  name: deploy_auth