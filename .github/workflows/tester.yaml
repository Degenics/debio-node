name: Tester

on:
  pull_request:
    branches:
      - main
      - releases/**

concurrency:
  group: tester-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  testing:
    runs-on: ubuntu-20.04
    name: Testing on Rust Toolchain Nightly
    strategy:
      matrix:
        node-version: [nightly]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Rust Toolchain
        id: setup-rust-toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly
          components: clippy, rustfmt
          target: wasm32-unknown-unknown
          override: true
          default: true
      - name: Initialize Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: List Changed
        id: list-changed
        uses: dorny/paths-filter@v2
        with:
          filters: |
            app-source:
              - 'node/**'
              - 'pallets/**'
              - 'primitives/**'
              - 'runtime/**'
              - '.rustfmt.toml'
              - 'Cargo.toml'
              - 'Cargo.lock'
      - name: Check Lint
        if: steps.list-changed.outputs.app-source == 'true'
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --workspace --all-features --locked -- -D warnings
      - name: Check Format
        if: steps.list-changed.outputs.app-source == 'true'
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --check
      - name: Run Test
        if: steps.list-changed.outputs.app-source == 'true'
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --workspace --locked
      - name: Run Build
        if: steps.list-changed.outputs.app-source == 'true'
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --locked
      - name: Run Build for Benchmarking
        if: steps.list-changed.outputs.app-source == 'true'
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --features=runtime-benchmarks --release --locked
